#!/bin/sh
# Author: Rack Lin <racklin@gmail.com>
#
DESC="sync client"
NAME=sync_client
PIDFILE=/var/run/$NAME.pid
SCRIPTNAME=/data/vivipos_webapp/sync_client
SCRIPTDIR=`dirname $SCRIPTNAME`
CMD=${1:-help}


#
# call cake.d sessions
#
do_sessions()
{


    # call irc client
    # because we don't want to update /etc/init.d and OS NOW!!!
    #
    if [ -x "${SCRIPTDIR}/irc_client" ]; then
        ${SCRIPTDIR}/irc_client ${CMD}
    fi

    #
    # check all extensions run-parts if cake.d exists
    #
    CAKESHELLDIR=/data/profile/extensions/*/cake.d
    CAKESHELLFILES=$(run-parts --list $CAKESHELLDIR)
    if [ -n "$CAKESHELLFILES" ]; then
        set +e
        for CAKESHELLFILE in $CAKESHELLFILES; do
            $CAKESHELLFILE ${CMD}
        done
        set -e
    fi

    return "0"
}


#
# Function that starts the daemon/service
#
do_start()
{
    RETVAL="0"

    if [ -f $PIDFILE ]; then
        ps -p `cat $PIDFILE` > /dev/null
        if [ "$?" != "0" ]; then
            ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client start
            RETVAL="$?"
        fi
    else
        # no running
        ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client start
        RETVAL="$?"
    fi

    return "$RETVAL"

}

#
# Function that stops the daemon/service
#
do_stop()
{

    if [ -f $PIDFILE ]; then
        ps -p `cat $PIDFILE` > /dev/null
        if [ "$?" = "0" ]; then
            # kill it
            kill -15 `cat $PIDFILE` > /dev/null
            sleep 2;
            kill -9 `cat $PIDFILE` > /dev/null
        fi

        # remove pidfile
        rm -f $PIDFILE
    fi
    return "0"

}

#
# Function that sends a SIGHUP to the daemon/service
#
do_reload() {

    if [ -f $PIDFILE ]; then
        ps -p `cat $PIDFILE` > /dev/null
        if [ "$?" = "0" ]; then
            # kill it
            kill -1 `cat $PIDFILE` > /dev/null
            return "0"
        fi

        return "1"
    fi
    return "1"

}

#
# Function that sync all and block until finish
#
do_sync_all()
{

    RETVAL="0"

    if [ -f /tmp/sync_client.request ]; then
        rm -f /tmp/sync_client.request;
    fi

    # suspend
    ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client addSyncSuspend

    if [ -f $PIDFILE ]; then
        ps -p `cat $PIDFILE` > /dev/null

        if [ "$?" = "0" ]; then
            # process and request exists wait
            ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client startSyncingAll
            RETVAL="$?"
        else
            # process not exists
            ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client startSyncingAll
            RETVAL="$?"
        fi
    else
            # process not exists
            ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client startSyncingAll
            RETVAL="$?"
    fi

    # suspend
    ${SCRIPTDIR}/cake/console/cake -app ${SCRIPTDIR}/app sync_client removeSyncSuspend

    return "$RETVAL"

}


#
# switch command
#
case "$1" in
  start)
	do_start
        do_sessions
	;;
  stop)
	do_stop
        do_sessions
	;;
  reload)
	do_reload
        do_sessions
        ;;
  restart)
	do_stop
        sleep 1
        do_start
        do_sessions
	;;
  sync)
        echo `date +%s` > /tmp/sync_client.request
        ;;
  sync_all)
        do_sync_all
        ;;
  *)
	echo "Usage: $SCRIPTNAME {start|stop|restart|reload|sync|sync_all}" >&2
	exit 3
	;;
esac

exit 0
