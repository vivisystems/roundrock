#!/usr/bin/env /bin/sh

#
# vivipos launcher
# 
. /etc/environment

#set -x
RETVAL=127;
DIR=`dirname $0`
DATABASE=/data/databases
SQLITE3=/usr/bin/sqlite3

# set X11 DISPLAY if zero
if [ -z "$DISPLAY" ]; then
  export DISPLAY=:0
fi

DIALOG=zenity
AOSD=aosd_cat
#
# include l10n messages
#
if [ -x /data/scripts/l10n_messages ]; then
    . /data/scripts/l10n_messages
fi
MSG_RUN_VIVIPOS_STARTING=${MSG_RUN_VIVIPOS_STARTING:-"Starting VIVIPOS ......"}
MSG_RUN_VIVIPOS_INTEGRITY_CHECK=${MSG_RUN_VIVIPOS_INTEGRITY_CHECK:-"Integrity Check:"}
MSG_RUN_VIVIPOS_REBUILDING=${MSG_RUN_VIVIPOS_REBUILDING:-"Rebuilding:"}
MSG_RUN_VIVIPOS_CONTACT=${MSG_RUN_VIVIPOS_CONTACT:-"Please contact technical support for assistance immediately!"}
MSG_RUN_VIVIPOS_REBOOT=${MSG_RUN_VIVIPOS_REBOOT:-"Reboot Machine"}
MSG_RUN_VIVIPOS_SHUTDOWN=${MSG_RUN_VIVIPOS_SHUTDOWN:-"Shutdown Machine"}

BACKUP_DIR="/data/backups"
DATE=`date +%Y%m%d`

DB_ERROR_FLAG=/tmp/.quick_check_error


#
# do sqlite vacuum 
#
do_vacuum()
{

    for i in $DATABASE/*.sqlite; do
        echo "VACUUM;" | $SQLITE3 $i ;
    done

    chmod -R 775 $DATABASE ;
}

#
# do sqlite journal check
#
do_journal_check()
{

    for i in $DATABASE/*.sqlite; do

        journal="$i-journal"

        if [ ! -f "$journal" ]; then
            touch $journal
            chmod 775 $journal
        fi
    done

}

#
# do sqlite quick check
#
do_quick_check()
{

        TOTAL_DBS=`ls -l $DATABASE/*.sqlite | wc -l`
        PERCENT=$((100/TOTAL_DBS))
        CUR_PERCENT=0

    (


        if [ -f $DB_ERROR_FLAG ]; then
            rm $DB_ERROR_FLAG
        fi

        for dbfile in $DATABASE/*.sqlite; do

                    dbname=`basename $dbfile`
                    CUR_PERCENT=$((CUR_PERCENT+PERCENT))

                    # /usr/bin/aosd_cat -F "Sans 20"  -x 100 -y -120 -d 600000 "${MSG_RUN_VIVIPOS_INTEGRITY_CHECK} ${dbname}" &
                    echo "`date +"%Y-%m-%d %H:%M:%S"` :   integrity_check [${dbname}]" >> ${DIR}/log/vivipos.log
                    
                    echo "${CUR_PERCENT}"
                    echo "# ${MSG_RUN_VIVIPOS_INTEGRITY_CHECK}  ${dbname} \t (${CUR_PERCENT}%)"
                    result=`$SQLITE3 $dbfile "PRAGMA quick_check" 2>&1`
                    QUICK_CHECK_ES=$?
                    sleep 2;

                    if [ "$QUICK_CHECK_ES" = "0" ] && [ ! -z "$result" ] && [ "$result" != "ok" ]; then

                        # NEED Rebuild
                        #/usr/bin/aosd_cat -F "Sans 20" -x 100 -y -80 -d 600000 "${MSG_RUN_VIVIPOS_REBUILDING} ${dbname}" &
                        echo "`date +"%Y-%m-%d %H:%M:%S"` :   rebuilding [${dbname}] (${result} ${QUICK_CHECK_ES})" >> ${DIR}/log/vivipos.log

                        echo "$((CUR_PERCENT+1))"
                        echo "# ${MSG_RUN_VIVIPOS_REBUILDING}  ${dbname} \t (${CUR_PERCENT}%)"

                        # copy to backup dir
                        if [ ! -d $BACKUP_DIR ]; then
                           mkdir $BACKUP_DIR
                        fi
                        cp $dbfile "${BACKUP_DIR}/${dbname}_${DATE}"

                        $SQLITE3 $dbfile ".dump" | $SQLITE3 $dbfile.tmp
                        ES=$?

                        if [ "0" = "$ES" ]; then
                            DB_VERSION=`$SQLITE3 $dbfile "PRAGMA user_version;"`
                            echo "PRAGMA user_version=${DB_VERSION};" | $SQLITE3 $dbfile.tmp ;
                            rm $dbfile
                            mv $dbfile.tmp $dbfile
                        else
                            echo "$dbfile\t$QUICK_CHECK_ES\t$result" >> $DB_ERROR_FLAG
                            echo "$((CUR_PERCENT+2))"
                            echo "# ${MSG_RUN_VIVIPOS_REBUILDING}   ${dbname} \t ERROR"
                            sleep 1
                        fi

                    elif [ "$QUICK_CHECK_ES" != "0" ]; then

                        # CANT NOT Rebuild
                        echo "`date +"%Y-%m-%d %H:%M:%S"` :      Can not rebuild [${dbname}]  (${result} ${QUICK_CHECK_ES})" >> ${DIR}/log/vivipos.log

                        if [ "$QUICK_CHECK_ES" != "5" ]; then

                            # copy to backup dir
                            if [ ! -d $BACKUP_DIR ]; then
                               mkdir $BACKUP_DIR
                            fi

                            cp $dbfile "${BACKUP_DIR}/${dbname}_${DATE}"
                            echo "$dbfile\t$QUICK_CHECK_ES\t$result" >> $DB_ERROR_FLAG

                        fi

                        echo "$((CUR_PERCENT+2))"
                        echo "# ${MSG_RUN_VIVIPOS_REBUILDING}   ${dbname} \t ERROR"

                    fi

        done
        echo "100"
        echo "# OK"

    ) | $DIALOG --progress \
          --width=500 --height=150 \
          --title="${MSG_RUN_VIVIPOS_INTEGRITY_CHECK}" \
          --text="${MSG_RUN_VIVIPOS_INTEGRITY_CHECK}" \
          --auto-close \
          --percentage=0

    if [ 1 = "$?" ]; then
        echo "`date +"%Y-%m-%d %H:%M:%S"` :   USER CANCEL integrity_check " >> ${DIR}/log/vivipos.log
    fi

}

#
# do disk usage check
#
do_disk_usage_check()
{
	if [ -x /data/scripts/diskspace_usage.sh ]; then
		/data/scripts/diskspace_usage.sh
	fi
}


# once a day
do_disk_usage_check

# for loop runing vivipos forever
while [ $RETVAL != 0 ]; do

    echo "`date +"%Y-%m-%d %H:%M:%S"` : Starting VIVIPOS FROM [run_vivipos]" >> ${DIR}/log/vivipos.log

    # do_vacuum

	do_quick_check
	#do_integrity_check
        do_journal_check


        if [ -f $DB_ERROR_FLAG ]; then

            ERROR_DB=`cat $DB_ERROR_FLAG`
            $DIALOG --error --width=600 --height=300 --text="${MSG_RUN_VIVIPOS_CONTACT} \n\n${ERROR_DB}"
            #$DIALOG --question --width=600 --height=300 --text="${MSG_RUN_VIVIPOS_CONTACT} \n\n${ERROR_DB}"
            #--ok-label="${MSG_RUN_VIVIPOS_SHUTDOWN}" --cancel-label="${MSG_RUN_VIVIPOS_REBOOT}"

            if [ 0 = "$?" ]; then
                /sbin/shutdown -h now
            else
                #/sbin/shutdown -r now
                /sbin/shutdown -h now
            fi

            exit 1

        else

            echo "`date +"%Y-%m-%d %H:%M:%S"` :   executing xulrunner [${DIR}/application.ini]" >> ${DIR}/log/vivipos.log

            /usr/bin/aosd_cat -x 100 -F "Sans 24" -d 800000  "$MSG_RUN_VIVIPOS_STARTING" &

            # set env of system info
            eval `${DIR}/getSystemLicenseStub -v|awk -F"=" '$1 ~ /[A-Za-z0-9_]+/ { print "export " $1 "=\"" $2 "\"";  }'`
            ${DIR}/xulrunner/xulrunner ${DIR}/application.ini
            RETVAL=$?

            echo "`date +"%Y-%m-%d %H:%M:%S"` : Exit VIVIPOS [${RETVAL}]" >> ${DIR}/log/vivipos.log

        fi

done

exit $RETVAL

