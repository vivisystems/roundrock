#!/bin/sh

#
# vivipos launcher
# 
. /etc/environment

RETVAL=127;
DIR=`dirname $0`
DATABASE=/data/databases
SQLITE3=/usr/bin/sqlite3

#
# do sqlite vacuum 
#
do_vacuum()
{

    for i in $DATABASE/*.sqlite; do
        echo "VACUUM;" | $SQLITE3 $i ;
    done

    chmod -R 775 $DATABASE ;
}


#
# do sqlite integrity check
#
do_integrity_check()
{

    for i in $DATABASE/*.sqlite; do
		result=`$SQLITE3 $i "PRAGMA integrity_check"`
		if [ "$result" != "ok" ]; then
                    /usr/bin/aosd_cat -y -120 -d 4000 "Rebuilding ..." &
			$SQLITE3 $i ".dump" | $SQLITE3 $i.tmp
                        cp $i.tmp $i
                        rm -f $i.tmp
		fi
    done

}

#
# do disk usage check
#
do_disk_usage_check()
{
	if [ -x /data/scripts/diskspace_usage.sh ]; then
		/data/scripts/diskspace_usage.sh
	fi
}


# for loop runing vivipos forever
while [ $RETVAL != 0 ]; do
    /usr/bin/aosd_cat -d 8000 "Starting VIVIPOS ......" &

    # do_vacuum

	# do_integrity_check
	do_integrity_check

	do_disk_usage_check

    ${DIR}/xulrunner/xulrunner ${DIR}/application.ini
    RETVAL=$?

done

